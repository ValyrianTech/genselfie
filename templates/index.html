{% extends "base.html" %}

{% block head %}
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
{% endblock %}

{% block body %}
<div class="container">
    <!-- Header -->
    <header class="header">
        {% if settings.banner_image %}
        <div class="banner" style="background-image: url('/uploads/{{ settings.banner_image }}')"></div>
        {% endif %}
        <div class="header-content">
            {% if settings.logo_image %}
            <img src="/uploads/{{ settings.logo_image }}" alt="{{ settings.app_name }}" class="logo">
            {% endif %}
            <h1>{{ settings.app_name }}</h1>
            <p class="tagline">{{ settings.tagline }}</p>
        </div>
    </header>

    <!-- Server Status -->
    <div class="server-status" id="server-status">
        <span class="status-indicator" id="status-indicator"></span>
        <span class="status-text" id="status-text">Checking server...</span>
        <span class="queue-info" id="queue-info"></span>
    </div>

    <!-- Step 1: Choose Style (Presets) -->
    {% if presets %}
    <div class="step" id="step-preset">
        <h3>Step 1: Choose Style</h3>
        <div class="preset-options">
            {% for preset in presets %}
            <label class="preset-option {% if loop.first %}selected{% endif %}"
                   data-price="{{ preset.price_cents }}"
                   data-allow-prompt="{{ 'true' if preset.allow_prompt_edit else 'false' }}"
                   data-prompt="{{ preset.prompt or '' }}">
                <input type="radio" name="preset_id" value="{{ preset.id }}" {% if loop.first %}checked{% endif %}>
                <div class="preset-option-content">
                    <span class="preset-name">{{ preset.name }}</span>
                    {% if preset.description %}
                    <span class="preset-desc">{{ preset.description }}</span>
                    {% endif %}
                    <span class="preset-price">{{ "%.2f"|format(preset.price_cents / 100) }} {{ settings.currency }}</span>
                    <span class="preset-size">{{ preset.width }}x{{ preset.height }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Prompt Editing (shown only if preset allows it) -->
    <div class="step" id="step-prompt" style="display: none;">
        <h3>Customize Prompt (Optional)</h3>
        <div class="form-group">
            <label for="custom-prompt">Generation Prompt</label>
            <textarea id="custom-prompt" name="custom_prompt" rows="3" placeholder="Describe how you want the selfie to look..."></textarea>
            <small class="help-text">You can modify the prompt to customize your selfie generation.</small>
        </div>
    </div>
    {% endif %}

    <!-- Examples Gallery (always rendered so JS can populate per preset) -->
    <section class="examples" id="examples-section">
        <h2>Examples</h2>
        <div class="gallery" id="examples-gallery">
            {% if examples %}
                {% for example in examples %}
                <div class="gallery-item">
                    <img src="{{ example.url }}" alt="Example selfie">
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </section>

    <!-- Image Lightbox Modal -->
    <div id="lightbox" class="lightbox" style="display: none;">
        <div class="lightbox-content">
            <button class="lightbox-close" aria-label="Close">&times;</button>
            <img id="lightbox-img" src="" alt="Full size example">
        </div>
    </div>

    <!-- Offline Message (shown by default until status is checked) -->
    <section class="offline-message" id="offline-message">
        <div class="offline-content">
            <h2>Server Offline</h2>
            <p>The image generation server is currently unavailable. Please try again later.</p>
            <p class="help-text">This page will automatically check for server availability.</p>
        </div>
    </section>

    <!-- Generation Form (hidden by default until server is confirmed online) -->
    <section class="generate-section" id="generate-section" style="display: none;">
        <h2>Get Your Selfie</h2>
        
        <!-- Step {{ "2" if presets else "1" }}: Profile Image -->
        <div class="step" id="step-image">
            <h3>Step {{ "2" if presets else "1" }}: Your Photo</h3>
            
            <div class="tabs">
                <button class="tab active" data-tab="social">Social Media</button>
                <button class="tab" data-tab="upload">Upload Photo</button>
            </div>
            
            <div class="tab-content active" id="tab-social">
                <div class="form-group">
                    <label for="platform">Platform</label>
                    <select id="platform" name="platform">
                        <option value="twitter">Twitter / X</option>
                        <option value="bluesky">Bluesky</option>
                        <option value="github">GitHub</option>
                        <option value="mastodon">Mastodon</option>
                        <option value="nostr">Nostr</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="handle">Handle</label>
                    <input type="text" id="handle" name="handle" placeholder="username">
                    <small class="help-text" id="handle-help">Enter your Twitter/X username without @</small>
                </div>
                <button type="button" class="btn btn-secondary" id="fetch-profile">Fetch Profile Photo</button>
            </div>
            
            <div class="tab-content" id="tab-upload">
                <div class="form-group">
                    <label for="photo-upload">Upload a photo</label>
                    <input type="file" id="photo-upload" name="photo" accept="image/*">
                </div>
            </div>
            
            <div class="preview" id="image-preview" style="display: none;">
                <img id="preview-img" src="" alt="Your photo">
                <span class="preview-label">Your photo</span>
            </div>
        </div>

        <!-- Step {{ "3" if presets else "2" }}: Payment -->
        <div class="step" id="step-payment">
            <h3>Step {{ "3" if presets else "2" }}: Payment</h3>
            
            <div class="price-display">
                <span class="price" id="price-display">{{ "%.2f"|format(presets[0].price_cents / 100 if presets else 0) }} {{ settings.currency }}</span>
            </div>
            
            <div class="payment-options">
                {% if settings.codes_enabled %}
                <div class="payment-option">
                    <h4>Promo Code</h4>
                    <div class="form-group">
                        <input type="text" id="promo-code" placeholder="Enter code">
                        <button type="button" class="btn btn-secondary" id="validate-code">Apply</button>
                    </div>
                    <div id="code-status"></div>
                </div>
                {% endif %}
                
                {% if settings.stripe_enabled %}
                <div class="payment-option">
                    <h4>Pay with Card</h4>
                    <div id="stripe-element"></div>
                    <button type="button" class="btn btn-primary" id="pay-stripe">Pay Now</button>
                </div>
                {% endif %}
                
                {% if settings.lightning_enabled %}
                <div class="payment-option">
                    <h4>Pay with Bitcoin Lightning</h4>
                    <button type="button" class="btn btn-primary" id="pay-lightning">Generate Invoice</button>
                    <div id="lightning-invoice" style="display: none;">
                        <canvas id="lightning-qr"></canvas>
                        <input type="text" id="lightning-request" readonly>
                        <button type="button" class="btn btn-secondary" id="copy-invoice">Copy</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Step 3: Generate -->
        <div class="step" id="step-generate" style="display: none;">
            <h3>Step 3: Generate!</h3>
            <button type="button" class="btn btn-primary btn-large" id="generate-btn">Generate Selfie</button>
        </div>

        <!-- Result -->
        <div class="step" id="step-result" style="display: none;">
            <h3>Your Selfie</h3>
            <div class="result-container">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating your selfie...</p>
                </div>
                <div id="result" style="display: none;">
                    <img id="result-img" src="" alt="Generated selfie">
                    <div class="result-actions">
                        <a id="download-btn" href="" download class="btn btn-primary">Download</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>Powered by <a href="https://linktr.ee/ValyrianTech" target="_blank" rel="noopener">ValyrianTech</a></p>
    </footer>
</div>

<script src="/static/js/app.js"></script>
{% endblock %}
