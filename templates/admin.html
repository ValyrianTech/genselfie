{% extends "base.html" %}

{% block title %}Admin - {{ settings.app_name }}{% endblock %}

{% block body %}
<div class="admin-container">
    <header class="admin-header">
        <h1>{{ settings.app_name }} Admin</h1>
        <form method="POST" action="/admin/logout" style="display: inline;">
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </header>

    <div class="admin-grid">
        <!-- Settings Section -->
        <section class="admin-section">
            <h2>App Settings</h2>
            <form method="POST" action="/admin/settings">
                <div class="form-group">
                    <label for="app_name">App Name</label>
                    <input type="text" id="app_name" name="app_name" value="{{ settings.app_name }}" required>
                </div>
                
                <div class="form-group">
                    <label for="tagline">Tagline</label>
                    <input type="text" id="tagline" name="tagline" value="{{ settings.tagline }}">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="primary_color">Primary Color</label>
                        <input type="color" id="primary_color" name="primary_color" value="{{ settings.primary_color }}">
                    </div>
                    <div class="form-group">
                        <label for="secondary_color">Secondary Color</label>
                        <input type="color" id="secondary_color" name="secondary_color" value="{{ settings.secondary_color }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="currency">Currency</label>
                    <select id="currency" name="currency">
                        <option value="USD" {% if settings.currency == 'USD' %}selected{% endif %}>USD</option>
                        <option value="EUR" {% if settings.currency == 'EUR' %}selected{% endif %}>EUR</option>
                        <option value="GBP" {% if settings.currency == 'GBP' %}selected{% endif %}>GBP</option>
                    </select>
                    <small class="help-text">Pricing is set per preset</small>
                </div>
                
                <div class="form-group">
                    <label>Payment Methods</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" name="codes_enabled" {% if settings.codes_enabled %}checked{% endif %}>
                            Promo Codes
                        </label>
                        <label>
                            <input type="checkbox" name="stripe_enabled" {% if settings.stripe_enabled %}checked{% endif %}>
                            Stripe
                        </label>
                        <label>
                            <input type="checkbox" name="lightning_enabled" {% if settings.lightning_enabled %}checked{% endif %}>
                            Lightning
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </section>

        <!-- Branding Section -->
        <section class="admin-section">
            <h2>Branding</h2>
            
            <div class="upload-group">
                <h3>Banner Image</h3>
                {% if settings.banner_image %}
                <img src="/static/uploads/{{ settings.banner_image }}" alt="Current banner" class="preview-small">
                {% endif %}
                <form method="POST" action="/admin/upload-banner" enctype="multipart/form-data">
                    <input type="file" name="file" accept="image/*" required>
                    <button type="submit" class="btn btn-secondary">Upload Banner</button>
                </form>
            </div>
            
            <div class="upload-group">
                <h3>Logo</h3>
                {% if settings.logo_image %}
                <img src="/static/uploads/{{ settings.logo_image }}" alt="Current logo" class="preview-small logo-preview">
                {% endif %}
                <form method="POST" action="/admin/upload-logo" enctype="multipart/form-data">
                    <input type="file" name="file" accept="image/*" required>
                    <button type="submit" class="btn btn-secondary">Upload Logo</button>
                </form>
            </div>
        </section>

        <!-- Influencer Images Section -->
        <section class="admin-section">
            <h2>Influencer Reference Images</h2>
            
            <div class="image-grid">
                {% for image in images %}
                <div class="image-card">
                    <img src="/static/uploads/{{ image.filename }}" alt="{{ image.original_name }}">
                    <div class="image-info">
                        <span>{{ image.original_name }}</span>
                        {% if image.is_primary %}<span class="badge">Primary</span>{% endif %}
                    </div>
                    <form method="POST" action="/admin/delete-influencer-image/{{ image.id }}">
                        <button type="submit" class="btn btn-danger btn-small">Delete</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            
            <form method="POST" action="/admin/upload-influencer-image" enctype="multipart/form-data" class="upload-form">
                <input type="file" name="file" accept="image/*" required>
                <label>
                    <input type="checkbox" name="is_primary"> Set as primary
                </label>
                <button type="submit" class="btn btn-primary">Upload Image</button>
            </form>
        </section>

        <!-- Presets Section -->
        <section class="admin-section">
            <h2>Generation Presets</h2>
            <p class="help-text">Create presets combining an influencer image with specific dimensions and prompts</p>
            
            {% if presets %}
            <div class="presets-list">
                {% for preset in presets %}
                <div class="preset-card {% if not preset.is_active %}preset-inactive{% endif %}">
                    <div class="preset-header">
                        <h3>{{ preset.name }}</h3>
                        <span class="badge {% if preset.is_active %}badge-success{% else %}badge-muted{% endif %}">
                            {{ "Active" if preset.is_active else "Inactive" }}
                        </span>
                    </div>
                    {% if preset.description %}
                    <p class="preset-description">{{ preset.description }}</p>
                    {% endif %}
                    <div class="preset-details">
                        <span><strong>Size:</strong> {{ preset.width }}x{{ preset.height }}</span>
                        <span><strong>Image ID:</strong> {{ preset.influencer_image_id }}</span>
                        <span><strong>Price:</strong> {{ "%.2f"|format(preset.price_cents / 100) }} {{ settings.currency }}</span>
                        <span><strong>Prompt Edit:</strong> {{ "Yes" if preset.allow_prompt_edit else "No" }}</span>
                    </div>
                    {% if preset.prompt %}
                    <div class="preset-prompt">
                        <strong>Prompt:</strong> {{ preset.prompt }}
                    </div>
                    {% endif %}
                    <div class="button-group">
                        <form method="POST" action="/admin/toggle-preset/{{ preset.id }}" style="display: inline;">
                            <button type="submit" class="btn btn-secondary btn-small">
                                {{ "Disable" if preset.is_active else "Enable" }}
                            </button>
                        </form>
                        <form method="POST" action="/admin/delete-preset/{{ preset.id }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-small">Delete</button>
                        </form>
                        <form method="POST" action="/admin/generate-all-examples" style="display: inline;">
                            <input type="hidden" name="preset_id" value="{{ preset.id }}">
                            <button type="submit" class="btn btn-primary btn-small">Generate All Examples</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <h3 style="margin-top: 24px;">Create New Preset</h3>
            <form method="POST" action="/admin/create-preset" class="preset-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="preset-name">Name</label>
                        <input type="text" id="preset-name" name="name" placeholder="e.g., Close-up Selfie" required>
                    </div>
                    <div class="form-group">
                        <label for="preset-image">Influencer Image</label>
                        <select id="preset-image" name="influencer_image_id" required>
                            {% for image in images %}
                            <option value="{{ image.id }}">{{ image.original_name }}{% if image.is_primary %} (Primary){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="preset-width">Width</label>
                        <input type="number" id="preset-width" name="width" value="1024" min="256" max="2048">
                    </div>
                    <div class="form-group">
                        <label for="preset-height">Height</label>
                        <input type="number" id="preset-height" name="height" value="1024" min="256" max="2048">
                    </div>
                </div>
                <div class="form-group">
                    <label for="preset-description">Description (optional)</label>
                    <input type="text" id="preset-description" name="description" placeholder="Brief description of this preset">
                </div>
                <div class="form-group">
                    <label for="preset-prompt">Prompt (optional)</label>
                    <textarea id="preset-prompt" name="prompt" rows="3" placeholder="Custom prompt for this preset..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="preset-price">Price (cents)</label>
                        <input type="number" id="preset-price" name="price_cents" value="500" min="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="allow_prompt_edit"> Allow fan to edit prompt
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Preset</button>
            </form>
        </section>

        <!-- Example Inputs Section -->
        <section class="admin-section">
            <h2>Example Inputs</h2>
            <p class="help-text">Images in <code>static/uploads/examples/</code> - used to generate example selfies</p>
            
            <div class="image-grid">
                {% for example in example_inputs %}
                <div class="image-card">
                    <img src="{{ example.url }}" alt="{{ example.name }}">
                    <div class="image-info">
                        <span>{{ example.name }}</span>
                    </div>
                    <div class="button-group">
                        <form method="POST" action="/admin/generate-example/{{ example.filename }}" style="display: inline;">
                            <select name="preset_id" required>
                                {% for p in presets %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary btn-small">Generate</button>
                        </form>
                        <form method="POST" action="/admin/delete-example-input/{{ example.filename }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-small">Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <form method="POST" action="/admin/upload-example-input" enctype="multipart/form-data" class="upload-form">
                <input type="file" name="file" accept="image/*" required>
                <button type="submit" class="btn btn-primary">Add Example Input</button>
            </form>
            
            {% if example_inputs and presets %}
            <div class="button-group" style="margin-top: 16px;">
                <form method="POST" action="/admin/generate-all-examples">
                    <label for="all-preset">Preset</label>
                    <select id="all-preset" name="preset_id" required>
                        {% for p in presets %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-secondary">Generate All Examples</button>
                </form>
            </div>
            {% endif %}
            
            <!-- Generated Examples -->
            <div style="margin-top: 20px;">
                <h3>Generated Examples</h3>
                <p class="help-text">Images in <code>static/uploads/generated/</code>. Filter by preset to browse examples for a style.</p>
                {% if presets %}
                <form method="GET" action="/admin" class="inline-form" style="margin-bottom: 12px;">
                    <label for="filter-preset">Filter by preset</label>
                    <select id="filter-preset" name="preset_id">
                        <option value="">All</option>
                        {% for p in presets %}
                        <option value="{{ p.id }}" {% if selected_preset_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-secondary btn-small">Apply</button>
                </form>
                {% endif %}
                {% if generated_examples %}
                <div class="image-grid">
                    {% for example in generated_examples %}
                    <div class="image-card">
                        <img src="{{ example.url }}" alt="{{ example.name }}">
                        <div class="image-info">
                            <span>{{ example.name }}</span>
                            {% if example.preset_id %}
                                <span class="badge">{{ preset_names.get(example.preset_id, ('Preset ' ~ example.preset_id)) }}</span>
                            {% endif %}
                        </div>
                        <div class="button-group">
                            <form method="POST" action="/admin/delete-generated/{{ example.relpath }}" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small">Delete</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="help-text">No generated examples found for the selected filter.</p>
                {% endif %}
            </div>
        </section>

        <!-- Promo Codes Section -->
        <section class="admin-section">
            <h2>Promo Codes</h2>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Uses</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code in codes %}
                    <tr>
                        <td><code>{{ code.code }}</code></td>
                        <td>
                            {% if code.uses_remaining is not none %}
                                {{ code.uses_remaining }} / {{ code.max_uses }}
                            {% else %}
                                Unlimited
                            {% endif %}
                        </td>
                        <td>
                            {% if code.expires_at %}
                                {{ code.expires_at.strftime('%Y-%m-%d') }}
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                        <td>
                            <form method="POST" action="/admin/delete-code/{{ code.id }}" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <form method="POST" action="/admin/create-code" class="inline-form">
                <input type="text" name="code" placeholder="Leave empty for random" style="text-transform: uppercase;">
                <input type="number" name="max_uses" placeholder="Max uses (empty = unlimited)" min="1">
                <input type="date" name="expires_at" placeholder="Expiry date">
                <button type="submit" class="btn btn-primary">Create Code</button>
            </form>
        </section>

        <!-- ComfyUI Section -->
        <section class="admin-section">
            <h2>ComfyUI Settings</h2>
            
            <div class="server-status" id="server-status">
                <span class="status-indicator" id="status-indicator"></span>
                <span class="status-text" id="status-text">Checking server...</span>
                <span class="queue-info" id="queue-info"></span>
            </div>
            
            <form method="POST" action="/admin/comfyui-url">
                <div class="form-group">
                    <label for="comfyui_url">Server URL</label>
                    <input type="url" id="comfyui_url" name="comfyui_url" 
                           value="{{ comfyui_url }}" 
                           placeholder="http://localhost:8188">
                </div>
                <button type="submit" class="btn btn-primary">Save URL</button>
            </form>
            
            <p class="help-text" style="margin-top: 16px;">Workflow: <code>workflows/genselfie.json</code></p>
        </section>

        <!-- Recent Generations Section -->
        <section class="admin-section full-width">
            <h2>Recent Generations</h2>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Platform</th>
                        <th>Handle</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gen in generations %}
                    <tr>
                        <td>{{ gen.id }}</td>
                        <td>{{ gen.fan_platform or '-' }}</td>
                        <td>{{ gen.fan_handle or '-' }}</td>
                        <td>
                            {{ gen.payment_method }}
                            {% if gen.promo_code_used %}({{ gen.promo_code_used }}){% endif %}
                        </td>
                        <td>
                            <span class="badge badge-{{ 'success' if gen.status == 'completed' else 'warning' if gen.status == 'processing' else 'error' if gen.status == 'failed' else 'default' }}">
                                {{ gen.status }}
                            </span>
                        </td>
                        <td>{{ gen.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>
</div>

<script>
(function() {
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const queueInfo = document.getElementById('queue-info');
    
    async function checkServerStatus() {
        try {
            const response = await fetch('/api/server-status');
            const data = await response.json();
            
            if (data.online) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'ComfyUI Online';
                const queueSize = data.queue_size || 0;
                queueInfo.textContent = `Queue: ${queueSize}`;
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'ComfyUI Offline';
                queueInfo.textContent = '';
            }
        } catch (error) {
            statusIndicator.className = 'status-indicator offline';
            statusText.textContent = 'ComfyUI Offline';
            queueInfo.textContent = '';
        }
    }
    
    // Check immediately and then every 10 seconds
    checkServerStatus();
    setInterval(checkServerStatus, 10000);
})();
</script>
{% endblock %}
